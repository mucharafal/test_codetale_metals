[{
  "comments": [{
    "author": {
      "login": "zsxwing"
    },
    "body": "This is flakey. You should check it with a timeout and also use a short connection timeout to make this test fast, such as\n\n``` Java\n  @Test\n  public void closeIdleConnectionForRequestTimeOut() throws IOException, InterruptedException {\n    TransportConf conf = new TransportConf(new ConfigProvider() {\n\n      @Override\n      public String get(String name) {\n        if (\"spark.shuffle.io.connectionTimeout\".equals(name)) {\n          // We should make sure there is enough time for us to observe the channel is active\n          return \"1s\";\n        }\n        String value = System.getProperty(name);\n        if (value == null) {\n          throw new NoSuchElementException(name);\n        }\n        return value;\n      }\n    });\n    TransportContext context = new TransportContext(conf, new NoOpRpcHandler());\n    TransportClientFactory factory = context.createClientFactory();\n    try {\n      TransportClient c1 = factory.createClient(TestUtils.getLocalHost(), server1.getPort());\n      assertTrue(c1.isActive());\n      long expiredTime = System.currentTimeMillis() + 10000; // 10 seconds\n      while (c1.isActive() && System.currentTimeMillis() < expiredTime) {\n        Thread.sleep(10);\n      }\n      assertFalse(c1.isActive());\n    } finally {\n      factory.close();\n    }\n  }\n```\n",
    "commit": "e444d119ec46d70b6d319b6bb4c6bc109935d5d5",
    "createdAt": "2015-11-05T19:24:02Z",
    "diffHunk": "@@ -177,4 +177,14 @@ public void closeBlockClientsWithFactory() throws IOException {\n     assertFalse(c1.isActive());\n     assertFalse(c2.isActive());\n   }\n+\n+  @Test\n+  public void closeIdleConnectionForRequestTimeOut() throws IOException, InterruptedException {\n+    TransportClientFactory factory = context.createClientFactory();\n+    TransportClient c1 = factory.createClient(TestUtils.getLocalHost(), server1.getPort());\n+    assertTrue(c1.isActive());\n+    Thread.sleep(conf.connectionTimeoutMs());\n+    assertFalse(c1.isActive());"
  }],
  "prId": 9227
}]