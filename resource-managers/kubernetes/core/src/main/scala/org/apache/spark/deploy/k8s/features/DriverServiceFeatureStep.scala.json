[{
  "comments": [{
    "author": {
      "login": "skonto"
    },
    "body": "it should be falling back to some default name. It is not necessarily the shorter if the preferred is invalid.",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:24:23Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {\n     preferredServiceName\n   } else {\n     val randomServiceId = KubernetesUtils.uniqueID(clock = clock)\n     val shorterServiceName = s\"spark-$randomServiceId$DRIVER_SVC_POSTFIX\"\n     logWarning(s\"Driver's hostname would preferably be $preferredServiceName, but this is \" +\n-      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters). Falling back to use \" +\n-      s\"$shorterServiceName as the driver service's name.\")\n+      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters) or is not a valid service name.\" +\n+      s\"Falling back to use $shorterServiceName as the driver service's name.\")",
    "line": 15
  }, {
    "author": {
      "login": "hehuiyuan"
    },
    "body": "This is only a method for dealing  with the invalid service name. If the name is invalid and we don't deal with it,  the job only has a driver pod. ",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:51:47Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {\n     preferredServiceName\n   } else {\n     val randomServiceId = KubernetesUtils.uniqueID(clock = clock)\n     val shorterServiceName = s\"spark-$randomServiceId$DRIVER_SVC_POSTFIX\"\n     logWarning(s\"Driver's hostname would preferably be $preferredServiceName, but this is \" +\n-      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters). Falling back to use \" +\n-      s\"$shorterServiceName as the driver service's name.\")\n+      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters) or is not a valid service name.\" +\n+      s\"Falling back to use $shorterServiceName as the driver service's name.\")",
    "line": 15
  }, {
    "author": {
      "login": "skonto"
    },
    "body": "I am referring to the warning message could be made more specific and also the name of the variable `shorterServiceName` . Since it may be invalid and not shorter in some cases I would replace shorterServiceName with defaultServiceName. Anyway this is nit.",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:55:15Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {\n     preferredServiceName\n   } else {\n     val randomServiceId = KubernetesUtils.uniqueID(clock = clock)\n     val shorterServiceName = s\"spark-$randomServiceId$DRIVER_SVC_POSTFIX\"\n     logWarning(s\"Driver's hostname would preferably be $preferredServiceName, but this is \" +\n-      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters). Falling back to use \" +\n-      s\"$shorterServiceName as the driver service's name.\")\n+      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters) or is not a valid service name.\" +\n+      s\"Falling back to use $shorterServiceName as the driver service's name.\")",
    "line": 15
  }, {
    "author": {
      "login": "hehuiyuan"
    },
    "body": "Oh，I got it!\r\n\r\n",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:57:53Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {\n     preferredServiceName\n   } else {\n     val randomServiceId = KubernetesUtils.uniqueID(clock = clock)\n     val shorterServiceName = s\"spark-$randomServiceId$DRIVER_SVC_POSTFIX\"\n     logWarning(s\"Driver's hostname would preferably be $preferredServiceName, but this is \" +\n-      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters). Falling back to use \" +\n-      s\"$shorterServiceName as the driver service's name.\")\n+      s\"too long (must be <= $MAX_SERVICE_NAME_LENGTH characters) or is not a valid service name.\" +\n+      s\"Falling back to use $shorterServiceName as the driver service's name.\")",
    "line": 15
  }],
  "prId": 24839
}, {
  "comments": [{
    "author": {
      "login": "skonto"
    },
    "body": "Is the svc name valid in all cases according to `com.google.common.net.InternetDomainName.isValid` as mentioned in the other PR?  It seems that the svc name which is up to 63 chars and has no dots in it matches a domain label (https://www.ietf.org/rfc/rfc3490.txt) so that method will cover the validation.",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:35:02Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {",
    "line": 6
  }, {
    "author": {
      "login": "hehuiyuan"
    },
    "body": "> Is the svc name valid in all cases according to `com.google.common.net.InternetDomainName.isValid` as mentioned in the other PR? As it is now it seems valid according to the spec: https://en.wikipedia.org/wiki/Domain_name.\r\n\r\nNow,  fabric8 API has some limitations，\r\n```java\r\n public class Service implements HasMetadata {\r\n    @NotNull\r\n    @JsonProperty(\"apiVersion\")\r\n    private String apiVersion = \"v1\";\r\n    @NotNull\r\n    @JsonProperty(\"kind\")\r\n    private String kind = \"Service\";\r\n    @JsonProperty(\"metadata\")\r\n    @Valid\r\n    @CheckObjectMeta(\r\n        regexp = \"^[a-z]([-a-z0-9]*[a-z0-9])?$\",\r\n        max = 63\r\n    )\r\n```\r\n\r\n`    @CheckObjectMeta(\r\n        regexp = \"^[a-z]([-a-z0-9]*[a-z0-9])?$\",\r\n        max = 63\r\n    )\r\n`",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:43:59Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {",
    "line": 6
  }, {
    "author": {
      "login": "skonto"
    },
    "body": "Yeah I saw that when digging into it. It should be ok from what I read: https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/ \"Assume a Service named foo in the Kubernetes namespace bar. A Pod running in namespace bar can look up this service by simply doing a DNS query for foo. A Pod running in namespace quux can look up this service by doing a DNS query for foo.bar.\" so it matches the domain label, that is why there are these limitations. @liyinan926 can you verify this?",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-06-11T10:52:29Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {",
    "line": 6
  }, {
    "author": {
      "login": "holdenk"
    },
    "body": "I don't understand the purpose of  `Character.isLetter` here, we've already filtered this down to only allow `[a-z0-9]`",
    "commit": "7ed72cba7824cc682c3b74ca54e276ef91012518",
    "createdAt": "2019-09-17T01:24:14Z",
    "diffHunk": "@@ -39,14 +39,15 @@ private[spark] class DriverServiceFeatureStep(\n       \"managed via a Kubernetes service.\")\n \n   private val preferredServiceName = s\"${kubernetesConf.resourceNamePrefix}$DRIVER_SVC_POSTFIX\"\n-  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH) {\n+  private val resolvedServiceName = if (preferredServiceName.length <= MAX_SERVICE_NAME_LENGTH\n+    && Character.isLetter(preferredServiceName.charAt(0))) {",
    "line": 6
  }],
  "prId": 24839
}]