[{
  "comments": [{
    "author": {
      "login": "brkyvz"
    },
    "body": "Have you tried this call? https://github.com/awslabs/amazon-kinesis-client/blob/master/src/main/java/com/amazonaws/services/kinesis/clientlibrary/lib/worker/RecordProcessorCheckpointer.java#L129\r\n\r\nIt seems you may add a `finalize` method to `KinesisCheckpointer` where you call the `IRecordProcessorCheckpointer.checkpoint(ExtendedSequenceNumber.SHARD_END.sequenceNumber, ExtendedSequenceNumber.SHARD_END.subSequenceNumber)`",
    "commit": "17a5c3a0b74414d2f65cfdf33d813599b1697804",
    "createdAt": "2016-12-09T19:28:36Z",
    "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.amazonaws.services.kinesis.clientlibrary.lib.worker;\n+\n+import com.amazonaws.services.kinesis.clientlibrary.exceptions.InvalidStateException;\n+import com.amazonaws.services.kinesis.clientlibrary.exceptions.ShutdownException;\n+import com.amazonaws.services.kinesis.clientlibrary.interfaces.IRecordProcessorCheckpointer;\n+import com.amazonaws.services.kinesis.clientlibrary.types.ExtendedSequenceNumber;\n+\n+\n+/**\n+ * This is a class to fix an issue in SPARK-18020. When resharding Kinesis streams,\n+ * the KCL throws an exception because Spark does not checkpoint `SHARD_END` to finish reading\n+ * closed shards in `KinesisRecordProcessor#shutdown`. This bug finally leads to stopping\n+ * subscribing new split (or merged) shards. However, trying checkpoints with `SHARD_END` throws\n+ * `IllegalArgumentException` exceptions with messages like \"Sequence number must be numeric,\n+ * but was SHARD_END\". This fix is a workaround and the class will be removed in future\n+ * if we find other better solutions.\n+ */\n+public class CheckpointerShim {\n+\n+  public static void shutdown(IRecordProcessorCheckpointer checkpointer)"
  }, {
    "author": {
      "login": "maropu"
    },
    "body": "Yea, I tried by [this version](https://github.com/maropu/spark-kinesis-sql-asl/blob/SPARK-18020-tests/spark/spark-2.0/kinesis-asl/src/main/scala/org/apache/spark/streaming/kinesis/KinesisCheckpointer.scala#L78), but I got the same exception;\r\n```\r\n16/12/10 05:49:00 ERROR ShutdownTask: Application exception.\r\njava.lang.IllegalArgumentException: Sequence number must be numeric, but was SHARD_END\r\n        at com.amazonaws.services.kinesis.clientlibrary.lib.worker.SequenceNumberValidator.validateSequenceNumber(SequenceNumberValidator.java:75)\r\n        at com.amazonaws.services.kinesis.clientlibrary.lib.worker.RecordProcessorCheckpointer.checkpoint(RecordProcessorCheckpointer.java:120)\r\n        at org.apache.spark.streaming.kinesis.KinesisCheckpointer.removeCheckpointer(KinesisCheckpointer.scala:77)\r\n        at org.apache.spark.streaming.kinesis.KinesisReceiver.removeCheckpointer(KinesisReceiver.scala:258)\r\n```\r\n\r\nIIUC this is a kind of aws library bugs. I asked in the kinesis forum [here](https://forums.aws.amazon.com/thread.jspa?threadID=244218), but I didn't get an answer.",
    "commit": "17a5c3a0b74414d2f65cfdf33d813599b1697804",
    "createdAt": "2016-12-10T05:53:25Z",
    "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.amazonaws.services.kinesis.clientlibrary.lib.worker;\n+\n+import com.amazonaws.services.kinesis.clientlibrary.exceptions.InvalidStateException;\n+import com.amazonaws.services.kinesis.clientlibrary.exceptions.ShutdownException;\n+import com.amazonaws.services.kinesis.clientlibrary.interfaces.IRecordProcessorCheckpointer;\n+import com.amazonaws.services.kinesis.clientlibrary.types.ExtendedSequenceNumber;\n+\n+\n+/**\n+ * This is a class to fix an issue in SPARK-18020. When resharding Kinesis streams,\n+ * the KCL throws an exception because Spark does not checkpoint `SHARD_END` to finish reading\n+ * closed shards in `KinesisRecordProcessor#shutdown`. This bug finally leads to stopping\n+ * subscribing new split (or merged) shards. However, trying checkpoints with `SHARD_END` throws\n+ * `IllegalArgumentException` exceptions with messages like \"Sequence number must be numeric,\n+ * but was SHARD_END\". This fix is a workaround and the class will be removed in future\n+ * if we find other better solutions.\n+ */\n+public class CheckpointerShim {\n+\n+  public static void shutdown(IRecordProcessorCheckpointer checkpointer)"
  }],
  "prId": 16213
}]