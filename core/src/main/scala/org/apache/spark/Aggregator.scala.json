[{
  "comments": [{
    "author": {
      "login": "kayousterhout"
    },
    "body": "If we're doing map-side combining, this should be for the shuffle write, right? (Is there a way to distinguish between these cases?)\n",
    "commit": "b38fe51c6eccc4c9dd7886153ab9acef23263272",
    "createdAt": "2015-02-12T19:48:33Z",
    "diffHunk": "@@ -54,14 +55,13 @@ case class Aggregator[K, V, C] (\n       }\n       combiners.iterator\n     } else {\n-      val combiners = new ExternalAppendOnlyMap[K, V, C](createCombiner, mergeValue, mergeCombiners)\n-      combiners.insertAll(iter)\n-      // Update task metrics if context is not null\n       // TODO: Make context non optional in a future release\n-      Option(context).foreach { c =>\n-        c.taskMetrics.memoryBytesSpilled += combiners.memoryBytesSpilled\n-        c.taskMetrics.diskBytesSpilled += combiners.diskBytesSpilled\n-      }\n+      val spillMetrics = Option(context).map(\n+        _.taskMetrics.getOrCreateShuffleReadSpillMetrics()).getOrElse(new WriteMetrics())"
  }, {
    "author": {
      "login": "sryza"
    },
    "body": "Ah yeah, looks like this is a copy/paste mistake.  In this path, I think we're always on the map side, so the call should just be `getOrCreateShuffleWriteSpillMetrics`.\n",
    "commit": "b38fe51c6eccc4c9dd7886153ab9acef23263272",
    "createdAt": "2015-02-13T05:50:06Z",
    "diffHunk": "@@ -54,14 +55,13 @@ case class Aggregator[K, V, C] (\n       }\n       combiners.iterator\n     } else {\n-      val combiners = new ExternalAppendOnlyMap[K, V, C](createCombiner, mergeValue, mergeCombiners)\n-      combiners.insertAll(iter)\n-      // Update task metrics if context is not null\n       // TODO: Make context non optional in a future release\n-      Option(context).foreach { c =>\n-        c.taskMetrics.memoryBytesSpilled += combiners.memoryBytesSpilled\n-        c.taskMetrics.diskBytesSpilled += combiners.diskBytesSpilled\n-      }\n+      val spillMetrics = Option(context).map(\n+        _.taskMetrics.getOrCreateShuffleReadSpillMetrics()).getOrElse(new WriteMetrics())"
  }],
  "prId": 2504
}]