[{
  "comments": [{
    "author": {
      "login": "JoshRosen"
    },
    "body": "The sorter doesn't incrementally update taskmetrics as it spills?\n",
    "commit": "9abecb9ff9bebd2305abcdf0a8fdf2b5b56347a9",
    "createdAt": "2015-07-30T19:04:30Z",
    "diffHunk": "@@ -78,6 +79,11 @@ case class ExternalSort(\n       val sorter = new ExternalSorter[InternalRow, Null, InternalRow](ordering = Some(ordering))\n       sorter.insertAll(iterator.map(r => (r.copy(), null)))\n       val baseIterator = sorter.iterator.map(_._1)\n+      val context = TaskContext.get()\n+      context.taskMetrics().incDiskBytesSpilled(sorter.diskBytesSpilled)",
    "line": 13
  }, {
    "author": {
      "login": "JoshRosen"
    },
    "body": "UnsafeExternalShuffleSorter actually has some really nice tests for its shuffle metrics, so those might be a nice model for how we can mock + stub to test this sort of thing.\n",
    "commit": "9abecb9ff9bebd2305abcdf0a8fdf2b5b56347a9",
    "createdAt": "2015-07-30T19:04:56Z",
    "diffHunk": "@@ -78,6 +79,11 @@ case class ExternalSort(\n       val sorter = new ExternalSorter[InternalRow, Null, InternalRow](ordering = Some(ordering))\n       sorter.insertAll(iterator.map(r => (r.copy(), null)))\n       val baseIterator = sorter.iterator.map(_._1)\n+      val context = TaskContext.get()\n+      context.taskMetrics().incDiskBytesSpilled(sorter.diskBytesSpilled)",
    "line": 13
  }, {
    "author": {
      "login": "andrewor14"
    },
    "body": "It's confusing. The sorter only does it if you call `writePartitionedFiles`, not when you drain the iterator. Here I believe it's just missing altogether.\n",
    "commit": "9abecb9ff9bebd2305abcdf0a8fdf2b5b56347a9",
    "createdAt": "2015-07-30T20:19:53Z",
    "diffHunk": "@@ -78,6 +79,11 @@ case class ExternalSort(\n       val sorter = new ExternalSorter[InternalRow, Null, InternalRow](ordering = Some(ordering))\n       sorter.insertAll(iterator.map(r => (r.copy(), null)))\n       val baseIterator = sorter.iterator.map(_._1)\n+      val context = TaskContext.get()\n+      context.taskMetrics().incDiskBytesSpilled(sorter.diskBytesSpilled)",
    "line": 13
  }],
  "prId": 7770
}]